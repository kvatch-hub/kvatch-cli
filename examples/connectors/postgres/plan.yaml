name: postgres-example
storage:
  type: sqlite

# CONNECTORS: Define where and how to access data (connections)
connectors:
  - name: books_db
    type: POSTGRES
    connection:
      host: localhost
      port: 5432
      database: books
      username: "${BOOKS_DB_USERNAME}"
      password: "${BOOKS_DB_PASSWORD}"
      ssl_mode: disable
    desc: "Books PostgreSQL database"

  - name: authors_db
    type: POSTGRES
    connection:
      host: localhost
      port: 5432
      database: authors
      username: "${AUTHORS_DB_USERNAME}"
      password: "${AUTHORS_DB_PASSWORD}"
      ssl_mode: disable
    desc: "Authors PostgreSQL database"

# DATASETS: Define how to process and translate data (plugins)
datasets:
  # Extract books from PostgreSQL using SQL plugin
  - name: books
    connector_name: books_db
    type: SQL
    query: "SELECT name as title, author, review FROM books"
    config:
      timeout: 30
  
  - name: authors
    connector_name: authors_db
    type: SQL
    query: "SELECT id, slug, name, bio FROM authors"
    dedupe_key:
     - id
     - slug
    config:
      timeout: 30

  # JOIN operation using the federated connector
  - name: author_books
    connector_name: federated
    type: SQL
    query: |
      SELECT a.name, b.title as title, b.review FROM authors a JOIN books b ON a.slug = b.author
    config:
      timeout: 60
    children:
      - dataset_name: authors
      - dataset_name: books
output:
  dataset_name: author_books