name: currency_conversion_example
storage:
  type: sqlite
  data_store_path: currency_conversion_example.db

# CONNECTORS
connectors:
  # Google Sheet with expenses in mixed currencies
  - name: expenses_sheet
    type: GOOGLESHEET
    connection:
      spreadsheet_id: "1rtM2nL31GLtS6kU2ZE91wb8dfhb34YRzmtG0lQKULZg"
      read_range: "expenses"
    desc: "Expenses in various currencies"

  # Frankfurter API (no key required)
  - name: fx_api
    type: API
    connection:
      url: "https://api.frankfurter.app/latest"
      method: GET
      query_params:
        from: EUR   # convert everything into EUR
      response_path: "$"
    desc: "Live exchange rates (EUR base)"

# DATASETS
datasets:
  # Raw expenses from Google Sheets
  - name: expenses
    connector_name: expenses_sheet
    type: GOOGLESHEET
    config:
      header_row_no: 1
    query: "expenses"
    desc: "Sheet with columns: date, category, amount, currency"

  # FX rates from Frankfurter
  - name: fx_rates
    connector_name: fx_api
    type: JSON
    options:
      normalize_nested_objects: true
      normalized_key_field_name: currency
      normalized_value_prefix: rate_
    query: "SELECT * FROM rates"
    dedupe_key:
      - currency
    desc: "Latest FX rates (EUR base)"

  # Final expenses converted into EUR
  - name: expenses_converted
    connector_name: federated
    type: SQL
    query: |
      SELECT
        e.date,
        e.category,
        e.amount,
        e.currency,
        CASE
          WHEN TRIM(UPPER(e.currency)) = 'EUR' THEN 1.0
          ELSE r.rate_value
        END AS fx_rate,
        ROUND(e.amount / 
          CASE WHEN TRIM(UPPER(e.currency)) = 'EUR' THEN 1.0 ELSE r.rate_value END, 2) AS amount_eur
      FROM expenses e
      LEFT JOIN fx_rates r 
        ON TRIM(UPPER(e.currency)) = TRIM(UPPER(r.currency))
    children:
      - dataset_name: expenses
      - dataset_name: fx_rates
    desc: "Expenses converted into EUR"

# OUTPUT
output:
  dataset_name: expenses_converted
  format: table
  verbose: true
